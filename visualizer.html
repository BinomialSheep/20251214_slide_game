<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Slide Game Viewer (JSONL)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    .wrap { display: grid; grid-template-columns: 1fr 360px; gap: 16px; align-items: start; }
    textarea { width: 100%; height: 420px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
    .panel { border: 1px solid #ccc; border-radius: 8px; padding: 12px; }
    table { border-collapse: collapse; margin-top: 8px; }
    td {
      width: 56px; height: 56px; border: 1px solid #444;
      text-align: center; vertical-align: middle; font-size: 22px;
      user-select: none;
    }
    td.center { background: #ffe7a8; }
    .row { display:flex; gap:8px; flex-wrap: wrap; align-items: center; }
    button { padding: 6px 10px; }
    input[type="number"] { width: 80px; }
    .err { color: #b00020; white-space: pre-wrap; margin-top: 8px; }
    .ok  { color: #0a7a1f; }
    .info { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; white-space: pre-wrap; }
    .piece {
      display: inline-flex;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      border: 2px solid rgba(0,0,0,0.25);
    }

    .p1 { background: #3b82f6; color: white; }   /* + の駒 */
    .p2 { background: #ef4444; color: white; }   /* - の駒 */

    td.center .piece { box-shadow: 0 0 0 3px rgba(0,0,0,0.15); }

  </style>
</head>
<body>
  <h2>Slide Game Viewer (paste JSONL)</h2>

  <div class="wrap">
    <div class="panel">
      <div class="row" style="justify-content: space-between;">
        <div class="row">
          <button id="load">Load</button>
          <button id="loadSample">Sample</button>
          <label class="row" style="gap:6px;">
            N:
            <input id="n" type="number" min="2" max="19" value="5" />
          </label>
        </div>
        <div class="row">
          <label class="row" style="gap:6px;">
            Delay(ms):
            <input id="delay" type="number" min="0" max="5000" value="200" />
          </label>
        </div>
      </div>

      <textarea id="src" placeholder='ここに moves.jsonl を貼り付けてください（1行=1手のJSON）&#10;例: {"ply":0,"player":1,"piece":3,"dir":"UP","from":[4,2],"to":[1,2]}'></textarea>
      <div id="status" class="info"></div>
      <div id="error" class="err"></div>
    </div>

    <div class="panel">
      <div class="row">
        <button id="prev">Prev</button>
        <button id="next">Next</button>
        <button id="play">Play</button>
        <button id="stop" disabled>Stop</button>
        <button id="reset">Reset</button>
      </div>
      <div style="margin-top:10px;" class="info" id="info">start</div>
      <table id="board"></table>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  let N = 5;
  let moves = [];
  let idx = -1;      // -1 = 初期状態
  let timer = null;

  function initBoard(n){
    const b = Array.from({length:n}, () => Array(n).fill(0));
    for(let i=0;i<n;i++) b[0][i] = -(i+1);     // P2
    for(let i=0;i<n;i++) b[n-1][i] = (i+1);   // P1
    return b;
  }

  function buildTable(n){
    const tbl = $("board");
    tbl.innerHTML = "";
    for(let y=0;y<n;y++){
      const tr = document.createElement("tr");
      for(let x=0;x<n;x++){
        const td = document.createElement("td");
        if(y === Math.floor(n/2) && x === Math.floor(n/2)) td.classList.add("center");
        tr.appendChild(td);
      }
      tbl.appendChild(tr);
    }
  }

  function render(board){
    const tbl = $("board");
    for(let y=0;y<N;y++){
      for(let x=0;x<N;x++){
        const td = tbl.rows[y].cells[x];
        const v = board[y][x];

        if(v === 0){
          td.innerHTML = "";
          continue;
        }

        const cls = (v > 0) ? "p1" : "p2";
        td.innerHTML = `<span class="piece ${cls}">${v}</span>`;
      }
    }
  }

  function recomputeBoard(uptoIdx){
    const b = initBoard(N);
    for(let k=0;k<=uptoIdx;k++){
      const m = moves[k];
      const [fy,fx] = m.from;
      const [ty,tx] = m.to;
      b[fy][fx] = 0;
      b[ty][tx] = m.piece;
    }
    return b;
  }

  function setInfo(){
    if(idx < 0){
      $("info").textContent = "start";
      return;
    }
    const m = moves[idx];
    $("info").textContent =
      `ply ${m.ply}  P${m.player}  piece ${m.piece} ${m.dir}\n` +
      `from [${m.from[0]},${m.from[1]}] -> to [${m.to[0]},${m.to[1]}]`;
  }

  function goto(i){
    if(i < -1) i = -1;
    if(i >= moves.length) i = moves.length - 1;
    idx = i;
    const b = (idx < 0) ? initBoard(N) : recomputeBoard(idx);
    render(b);
    setInfo();
  }

  function stop(){
    if(timer){
      clearInterval(timer);
      timer = null;
    }
    $("play").disabled = false;
    $("stop").disabled = true;
  }

  function parseJSONL(text){
    const lines = text.split(/\r?\n/).map(s => s.trim()).filter(s => s.length > 0);
    const arr = [];
    for(let i=0;i<lines.length;i++){
      try{
        const obj = JSON.parse(lines[i]);
        // 最低限のバリデーション
        if(!("from" in obj) || !("to" in obj) || !("piece" in obj)) {
          throw new Error("missing fields (need from/to/piece)");
        }
        // dir は文字でも数値でもOKにしておく
        if(typeof obj.dir === "number"){
          obj.dir = ["UP","DOWN","LEFT","RIGHT"][obj.dir] ?? String(obj.dir);
        }
        arr.push(obj);
      } catch(e){
        throw new Error(`line ${i+1}: ${e.message}\n> ${lines[i]}`);
      }
    }
    return arr;
  }

  function loadFromTextarea(){
    stop();
    $("error").textContent = "";
    $("status").textContent = "";

    N = parseInt($("n").value, 10);
    if(!Number.isFinite(N) || N < 2) N = 5;

    buildTable(N);

    const text = $("src").value;
    let arr;
    try{
      arr = parseJSONL(text);
    }catch(e){
      $("error").textContent = String(e.message);
      moves = [];
      idx = -1;
      render(initBoard(N));
      setInfo();
      return;
    }

    moves = arr;
    idx = -1;
    render(initBoard(N));
    setInfo();
    $("status").textContent = `loaded ${moves.length} moves.`;
    $("status").className = "info ok";
  }

  $("load").onclick = loadFromTextarea;

  $("loadSample").onclick = () => {
    $("src").value =
`{"ply":0,"player":1,"piece":3,"dir":"UP","from":[4,2],"to":[1,2]}
{"ply":1,"player":2,"piece":-3,"dir":"DOWN","from":[0,2],"to":[3,2]}
{"ply":2,"player":1,"piece":1,"dir":"UP","from":[4,0],"to":[2,0]}`;
    loadFromTextarea();
  };

  $("prev").onclick = () => goto(idx - 1);
  $("next").onclick = () => goto(idx + 1);
  $("reset").onclick = () => goto(-1);

  $("play").onclick = () => {
    if(moves.length === 0) return;
    if(idx >= moves.length - 1) goto(-1);

    const delay = Math.max(0, parseInt($("delay").value, 10) || 200);
    $("play").disabled = true;
    $("stop").disabled = false;

    timer = setInterval(() => {
      if(idx >= moves.length - 1){
        stop();
        return;
      }
      goto(idx + 1);
    }, delay);
  };

  $("stop").onclick = stop;

  // 初期描画
  buildTable(N);
  render(initBoard(N));
  setInfo();
})();
</script>
</body>
</html>
